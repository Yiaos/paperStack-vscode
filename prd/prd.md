## 4. VS Code 插件（PaperStack Extension）

### 4.1 背景与定位
VS Code 插件用于在 IDE 内提供 PaperStack 的核心体验，包括：
- **写作/编译相关配置的统一入口**（降低用户寻找设置与理解成本）
- **AI 助手能力入口**（覆盖论文写作与 LaTeX 工作流的高频辅助场景）
- **用量与权限的可感知体验**（让用户理解可用状态、失败原因与解决方式）

插件目标是让用户在 VS Code 内完成论文写作/排错/润色等高频操作，而不是替代 VS Code 与既有 LaTeX 生态。

本插件基于 [OpenCode](https://opencode.ai) 客户端-服务端架构，在标准 OpenCode GUI 基础上进行了面向学术写作场景的深度定制。

---

### 4.2 目标（Goals）

#### 4.2.1 P0 目标
1. 用户可以在插件内完成最常用的写作/编译体验配置，并且配置后立即生效（可回显、可恢复默认）。
2. 用户可以在插件内使用 AI 助手完成：解释错误、润色改写、翻译、摘要/改写等核心场景，并支持将结果写回编辑器。
3. 用户可以在插件内看到 AI 能力的基本状态（是否可用、是否额度不足、请求失败原因），并获得可执行的下一步建议。
4. 用户可以显式管理 AI 的输入上下文（多文件附加、选区引用），并实时感知 Token 用量。
5. 用户可以对 AI 的敏感操作（文件写入、命令执行）进行逐条授权或拒绝，保障安全可控。
6. 用户可以回溯和修改历史消息，从任意节点重新生成 AI 回复，避免浪费 Token。

#### 4.2.2 P1 目标
1. AI 支持更丰富的写作工作流快捷操作（例如：生成引用条目、结构重排、风格统一等）。
2. 能明确区分个人偏好与项目偏好。
3. 更完善的对话与写作资产管理（会话搜索、导出、跨设备同步等）。
4. 支持消息队列（Outbox），用户在 AI 生成过程中可继续输入并排队发送，保持心流不被打断。

---

### 4.3 非目标（Non-goals）
1. 不替代用户现有的编译工具链与使用入口（用户仍可使用原有编译/预览入口与流程）。
2. 不提供完整版本控制能力（Git 相关能力仍由 VS Code/Git 工具承担）。
3. 不在插件中引导用户配置第三方模型密钥（若产品体系要求统一账号/额度管理，则插件侧不暴露密钥入口）。预留此功能，暂不开放给用户。

---

### 4.4 用户与使用场景（Personas & Scenarios）

#### 4.4.1 核心用户
- 学术写作者：需要润色、翻译、摘要、结构建议与引用辅助。
- LaTeX 用户：频繁遇到编译错误，期望快速定位原因并得到可执行修改建议。
- 团队协作用户：希望配置一致、输出风格一致、用量与权限透明。

#### 4.4.2 典型场景
1. **初次打开项目**：用户希望快速找到主文件、引擎、PDF 打开方式等关键设置。
2. **编译失败**：用户希望一键解释错误，得到"原因 + 修改点 + 可复制/可替换的改法"。
3. **段落润色**：用户选中一段文字或指定某段内容，快速学术化润色并替换回原文。
4. **中英互译**：用户将摘要/引言在中英之间互译，并保持学术表达风格。
5. **多文件上下文分析**：用户同时引用多个 `.tex` 文件和 `.bib` 文件，让 AI 分析结构或查找引用问题。
6. **历史对话纠偏**：用户发现第 2 轮提问方向偏了，回溯修改后重新生成，无需开新会话。
7. **长文写作（P1）**：基于多段上下文给结构建议、统一风格、生成小节摘要等。

---

### 4.5 功能需求（Functional Requirements）

#### 4.5.1 设置面板（Settings）

##### 4.5.1.1 集成式设置抽屉（Settings Drawer）

**核心理念**：在 AI 面板侧边实现滑出式抽屉，直接映射并读写 VS Code 配置项 (`vscode.workspace.getConfiguration`)，避免用户跳转到 `settings.json` 或全局设置界面，维持写作沉浸感。

##### 4.5.1.2 P0 配置项 - 点击即打开，可参考 @img/continue-settings.png
1. **主入口文件（Main TeX File）** → `paperstack.mainFile`
   - 用户可从当前工作区内选择一个 `*.tex` 文件作为主文件
   - 插件需显示当前已选择主文件
   - 若未选择，提供默认值与显式提示（例如默认 `main.tex`）
   - 拉取 `.tex` 文件列表时增加超时保护，避免大工作区卡死

2. **编译引擎偏好** → `latex-workshop.latex.recipe.default`
   - 用户可在 XeLaTeX / PDFLaTeX 之间切换偏好
   - 插件需显示当前选择，并提供简要说明（适用场景简述）

3. **PDF 打开方式** → `latex-workshop.view.pdf.viewer`
   - 用户可选择在编辑器标签页打开或以外部方式打开（如浏览器/新窗口）
   - 插件需显示当前选择

4. **编辑器字体大小** → `editor.fontSize`
   - 用户可选择预设值或输入数值
   - 插件需立即回显当前字体大小

5. **主题** → `workbench.colorTheme`
   - 用户可选择主题（至少支持设置为默认浅色主题）
   - 插件需回显当前主题
   - Webview 内的样式应同步更新以匹配新主题

##### 4.5.1.3 通用交互要求
- 配置变更应有"未保存"提示（如存在保存动作）
- 支持"一键恢复默认"
- 写入失败时必须提示原因或下一步动作（例如权限不足、配置不可写等）
- 设置项需在插件面板中与实际生效状态一致，避免"面板显示与实际不一致"

##### 4.5.1.4 P1 增强
- 支持"仅对当前项目生效"的偏好（与个人偏好区分），并明确显示当前配置来源（个人/项目）
- 支持导入/导出偏好（便于迁移与团队一致性）

---

#### 4.5.2 AI 面板（AI Assistant）

##### 4.5.2.1 P0 核心能力

**1. 对话（Chat）**
- 支持新建会话、会话列表、会话重命名、删除
- 启动时按更新时间自动选取最近会话
- 支持多轮对话与历史查看
- 支持流式输出体验（逐步显示生成结果）
- 支持展示思考过程
- 支持复制输出内容

**2. 消息回溯与编辑（Time Travel）**
- 用户可点击历史消息的"编辑"按钮，修改已发送的内容
- 修改后自动撤销该消息之后的所有对话记录
- AI 从修改点重新生成回复
- 会话历史中不保留被撤销的旧消息

```gherkin
Scenario: 用户修改历史提问
  Given 用户与 AI 进行了 3 轮对话 (A1 -> B1 -> A2 -> B2 -> A3 -> B3)
  When 用户点击 A2 消息的 "编辑" 按钮
  And 用户将 A2 的内容修改为新内容并重新发送
  Then 界面应移除 A2 之后的所有消息 (B2, A3, B3)
  And AI 应基于修改后的 A2 生成新的回复
```

**3. 显式上下文管理（Explicit Context Management）**
- 用户可通过资源管理器右键菜单将文件添加到 AI 上下文 ("Add to AI Context")
- 输入栏上方显示已附加文件的标签列表，支持逐个移除
- 发送 Prompt 时自动将附加文件内容注入请求
- 保留现有的选区传递 (`/command`) 能力

```gherkin
Scenario: 添加多个文件作为上下文
  Given 用户打开了 InputBar
  When 用户在资源管理器中右键点击 "utils.ts" 并选择 "Add to AI Context"
  And 用户在资源管理器中右键点击 "api.ts" 并选择 "Add to AI Context"
  Then 输入栏上方应显示 2 个文件标签 ["utils.ts", "api.ts"]
  When 用户发送 Prompt "分析这两个文件的依赖关系"
  Then AI 接收到的 Prompt 应包含这两个文件的完整内容
```

**4. 上下文用量可视化（Context Usage Ring）**
- 输入栏区域集成环形进度指示器，基于 OpenCode SDK 返回的 Session 元数据实时计算 Token 使用率
- 计算公式：`usage = (used_tokens / max_context_window) * 100%`
- 颜色阈值：绿色 (< 70%) → 黄色 (70%-90%) → 红色 (> 90%)
- 用户可直观感知何时需要开启新会话

```gherkin
Scenario: 用量警告
  Given 一个长会话，Token 使用量达到 100000 (约 78%)
  When 界面渲染时
  Then 进度环应当显示 "78%" 且颜色变为黄色
```

**5. 快捷动作（Commands）** — 此部分作为长线迭代功能，后续需支持快速添加
- 修复 LaTeX 编译错误（`/fix`）
- 学术化润色（`/polish`）
- 中英学术互译（`/translate`）
- 生成摘要（`/abstract`）
- 改写段落（`/rewrite`）
- 模拟审稿建议（`/review-suggest`）
- 生成回复信（`/review-reply`）

以上命令封装了领域专用的系统提示词（System Prompts），能自动感知选区上下文，无需用户编写冗长 Prompt。

```gherkin
Scenario: Fix LaTeX compilation error
  Given 用户在编辑器中选中了一段包含语法错误的 LaTeX 代码
  When 用户在输入框输入 "/fix" 并发送
  Then AI 应当分析选中的代码片段
  And AI 应当返回修复后的 LaTeX 代码块
```

**6. 工具调用权限控制（Tool Permissions）**
- AI Agent 执行敏感操作（如 `fs.write_file`, `shell.exec`）时，界面弹出权限请求卡片
- 卡片显示操作详情（工具名称、目标路径/命令）
- 提供三个选项："拒绝" / "允许一次" / "始终允许"
- 用户拒绝时，AI 收到 "Permission denied" 错误，文件系统无变更

```gherkin
Scenario: AI 尝试写入文件
  Given 用户要求 AI "创建一个新组件 Button.tsx"
  When AI 尝试调用 fs.write_file 工具
  Then 界面应弹出权限请求卡片
  And 卡片应显示 "AI 请求写入文件: src/components/Button.tsx"
  And 卡片应提供选项 ["拒绝", "允许一次", "始终允许"]
```

**7. 失败与限额体验**
- AI 不可用/额度不足/请求失败时，需在 UI 给出可理解的原因与下一步建议
- 支持"重试"与"取消生成"
- 在对话中保留失败记录（便于用户反馈与排查），对话名支持用户自定义修改

##### 4.5.2.2 P1 增强能力
- **消息队列与流控（Outbox）**：AI 生成过程中用户可继续输入并发送，消息进入队列，当前生成结束后自动处理
- 在 AI 思考过程中，支持继续提交补充内容，AI 可以实时利用这些最新内容
- 会话搜索与导出
- 多模型选择（如产品允许），并可显示差异化说明（速度/成本/质量）

```gherkin
Scenario: 生成过程中追加消息 (P1)
  Given AI 正在流式输出一条长回复 (状态为 Generating)
  When 用户在输入框输入 "还有，请补充单元测试" 并点击发送
  Then 输入框应清空
  And 界面上应显示用户的第二条消息，状态标记为 "Pending" (排队中)
  When AI 完成当前回复的生成
  Then 系统应自动开始处理队列中的消息
```

---

#### 4.5.3 安全与计费（Security & Billing）

##### 4.5.3.1 混合计费与 Key 管理（Hybrid Billing）
- **平台模式**：普通用户使用平台提供的 Key（计费归属平台），无需配置
- **BYOK 模式**（预留，暂不开放）：高级用户可通过 VS Code `SecretStorage` 安全存储自己的 API Key
- 输入栏底部提供下拉菜单，允许切换 "Platform Key" 和 "Custom Key"
- AI Gateway 根据请求头中的 Authorization 信息路由流量

```gherkin
Scenario: 平台模式 (默认)
  Given 用户未配置个人 Key 或选择了 "Use PaperStack Platform"
  When 用户发送消息
  Then 请求头中不包含用户自定义的 Authorization 字段
  And AI Gateway 应注入服务端配置的 Platform Key
  And 费用计入平台的 Provider 账号
```

##### 4.5.3.2 推理模型预配置（Reasoning Model Pre-configuration）
- AI Gateway 中针对不同模型预设最佳推理参数（如 `reasoning_effort`, `thinking.budget_tokens`）
- 用户侧 UI 只展示模型名称，隐藏底层参数复杂度
- 用户无需关心 `reasoning_effort: high` 或 `thinking: { budget_tokens: 16000 }` 等配置

---

#### 4.5.4 基础设施（Infrastructure）

##### 4.5.4.1 SSE 代理通信（SSE Proxy for Remote）
- 通过 VS Code Extension Host (Node.js) 作为中转，将 OpenCode Server 的 SSE 事件转发给 Webview
- 解决 Remote SSH / Codespaces / Coder 等环境下 Webview 直连 `localhost` 的 CORS 和网络隔离问题
- 确保任何网络环境下都能稳定进行流式通信

```gherkin
Scenario: 在远程容器中运行
  Given Extension 运行在远程 Coder 环境中
  And Webview 运行在本地浏览器中
  When Webview 尝试建立 SSE 连接
  Then 连接请求应指向 Extension Host 的消息通道
  And Extension Host 应成功转发 OpenCode Server 的事件
  And Webview 应实时显示流式输出
```

---

### 4.6 体验要求（UX Requirements）

1. **入口清晰**：用户可以在 10 秒内找到 Settings 与 AI 面板。
2. **可执行输出**：解释错误需给出明确修改点；润色需可一键替换选区。
3. **可控性优先**：任何会导致内容改动的动作都必须可撤销（至少支持 VS Code 的撤销链）。
4. **透明度**：用户能理解"本次 AI 用了什么上下文""为什么失败""该怎么继续"。
5. **双行高密度输入布局**：底部输入区采用双行布局以容纳所有功能控件：
   - **第一行**：核心交互（Agent 模式选择、Model 选择、输入框、附件、发送按钮）
   - **第二行**：状态与配置（Key Manager 下拉、Provider 状态灯、Context Usage 进度环）
   - 保持总高度约 80px，最大限度展示关键信息而不拥挤

---

### 4.7 兼容性与限制（Product Constraints）
1. 插件需要适配常见论文项目结构（单主文件、多文件拆分、图片与 bib 目录）。
2. 插件不应强制用户改变既有编译入口与习惯。
3. 当工作区缺少主文件、或存在多个候选主文件时，必须有明确处理方式（默认值/提示/引导选择）。
4. 插件需在 Remote SSH、Codespaces、Coder 等远程环境中正常工作（通过 SSE 代理通信保障）。

---

### 4.8 验收标准（Acceptance Criteria）

#### 4.8.1 设置面板
1. 主文件、引擎、PDF 打开方式、字体、主题均可在集成抽屉中配置、可回显、可恢复默认。
2. 修改设置后，实际编辑器/预览行为与设置一致，Webview 样式同步更新。
3. 写入失败时给出明确提示，并可引导用户解决。

#### 4.8.2 AI 面板 - 可参考 @img/codex.png
1. 支持会话管理（新建/列表/删除/重命名），启动时自动选取最近会话。
2. 支持流式输出、取消生成、重试、复制。
3. 支持消息回溯编辑：修改历史消息后移除后续记录，从修改点重新生成。
4. 支持显式上下文管理：用户可附加多个文件，输入栏上方显示文件标签列表。
5. 上下文用量环形指示器正确显示 Token 使用率和颜色阈值。
6. 全部 7 个 LaTeX 快捷命令 (`/fix`, `/polish`, `/translate`, `/abstract`, `/rewrite`, `/review-suggest`, `/review-reply`) 可正常触发并返回预期结果。
7. AI 执行敏感操作时弹出权限请求卡片，用户可拒绝/允许一次/始终允许。
8. AI 不可用/额度不足/请求失败时，UI 提示清晰并提供可操作建议。

#### 4.8.3 基础设施
1. 在远程环境（Remote SSH/Codespaces/Coder）中，SSE 代理通信正常，流式输出无中断。
2. 混合计费系统在平台模式下正常路由，BYOK 模式（预留）逻辑可验证。
3. 推理模型参数自动注入，用户无感知。
